#!/bin/bash

# Unofficial bash strict mode http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -eu
set -o pipefail
IFS=$'\n\t'


if [ ! -z "${CIRCLECI:-}" ]; then

  REPORTS_PATH=${REPORTS_PATH:=".artifacts"}
  mkdir -p "$REPORTS_PATH"

  gotestsum --junitfile "$REPORTS_PATH/gotestsum-report.xml" -- -covermode=count -coverprofile="$REPORTS_PATH/cover.out" ./...
  go tool cover -html="$REPORTS_PATH/cover.out" > "$REPORTS_PATH/cover.html"

  if [ ! -z "${COVERALLS_TOKEN:-}" ]; then
    goveralls -coverprofile="$REPORTS_PATH/cover.out" -service=circle-ci -repotoken="$COVERALLS_TOKEN"
  fi

else

  gotestsum

fi
